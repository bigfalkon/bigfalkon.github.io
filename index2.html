<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Gelişmiş Görünüm</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#443a74"/>
    <script>
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(function() {
                console.log('Service Worker Kaydedildi');
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Metamorphous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --md-sys-color-primary-rgb: 189, 179, 255;
            --md-sys-color-primary: rgb(var(--md-sys-color-primary-rgb));
            --md-sys-color-on-primary: #2d235c;
            --md-sys-color-primary-container: #443a74;
            --md-sys-color-on-primary-container: #e6deff;
            --md-sys-color-background: #131318;
            --md-sys-color-on-background: #e5e1e6;
            --md-sys-color-surface: #1a191f;
            --md-sys-color-surface-container: #201f25;
            --md-sys-color-surface-container-high: #2a2830;
            --md-sys-color-on-surface: #e5e1e6;
            --md-sys-color-on-surface-variant: #c8c4d0;
            --md-sys-color-outline-variant: #48454e;
            --md-sys-color-success-rgb: 102, 187, 106;
            --md-sys-color-success: rgb(var(--md-sys-color-success-rgb));
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-danger-rgb: 239, 83, 80;
            --md-sys-color-danger: rgb(var(--md-sys-color-danger-rgb));
            --md-sys-color-on-danger: #ffffff;
            --md-sys-color-warning-rgb: 255, 183, 77;
            --md-sys-color-warning: rgb(var(--md-sys-color-warning-rgb));
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); }
        .form-input, .form-select { background-color: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface); border-radius: 8px; padding: 12px; width: 100%; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 3px rgba(var(--md-sys-color-primary-rgb), 0.2); outline: none; }
        .item-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 16px; background-color: var(--md-sys-color-surface-container); transition: all 0.2s ease-in-out; border: 1px solid var(--md-sys-color-outline-variant); }
        .item-card:hover { transform: translateY(-4px); background-color: var(--md-sys-color-surface-container-high); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        .item-card.retired { opacity: 0.7; border-left: 4px solid var(--md-sys-color-warning); }
        .item-card.retired:hover { transform: translateY(0); opacity: 0.8; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 700; text-decoration: none; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-success { background-color: var(--md-sys-color-success); color: var(--md-sys-color-on-success); }
        .btn-secondary { background-color: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant); }
        .btn-secondary:hover { border-color: var(--md-sys-color-primary); color: var(--md-sys-color-primary); background-color: rgba(var(--md-sys-color-primary-rgb), 0.08); transform: translateY(0); box-shadow: none; }
        .btn-danger { background-color: var(--md-sys-color-danger); color: var(--md-sys-color-on-danger); }
        .icon-button { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 50%; background-color: transparent; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s; }
        .icon-button:hover.edit-button { background-color: rgba(var(--md-sys-color-primary-rgb), 0.1); color: var(--md-sys-color-primary); }
        .icon-button:hover.delete-button { background-color: rgba(var(--md-sys-color-danger-rgb), 0.1); color: var(--md-sys-color-danger); }
        .icon-button:hover.retire-button { background-color: rgba(var(--md-sys-color-warning-rgb), 0.1); color: var(--md-sys-color-warning); }
        .modal-backdrop { z-index: 1000; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--md-sys-color-surface-container); border-radius: 24px; padding: 1.5rem; width: 100%; max-width: 550px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .report-modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid var(--md-sys-color-outline-variant); padding-bottom: 0.5rem; }
        .report-modal-content p, .report-modal-content li { margin-bottom: 0.5rem; }
        .enlarged-image-container { z-index: 1100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .enlarged-image { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .character-selector-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .character-selector-item:hover { background-color: var(--md-sys-color-surface-container-high); }
        .image-input-container .url-input-wrapper, .edit-image-uploader { display: none; }
        .upload-service-chooser { display: none; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-screen-xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b" style="border-color: var(--md-sys-color-outline-variant);">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--md-sys-color-primary);">Yönetim Paneli</h1>
                <p class="text-lg mt-2" style="color: var(--md-sys-color-on-surface-variant);">Karakterleri, Füzyonları ve Gizli Sırları Yönet</p>
            </div>
            <div id="auth-button-container">
                <button id="auth-action-btn" class="btn btn-secondary"><span id="auth-action-icon" class="material-symbols-outlined">login</span><span id="auth-action-text">Giriş Yap</span></button>
            </div>
        </header>
        
        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-center">
            <input type="text" id="search-input" placeholder="Kayıtlar içinde ara..." class="form-input md:col-span-2">
            <select id="view-filter" class="form-select">
                <option value="all">Tüm Kayıtlar</option>
                <option value="available">Boştaki Karakterler</option>
                <option value="preview-report">Füzyon Önizleme Raporu</option>
            </select>
            <select id="sort-by" class="form-select">
                <option value="name_asc">İsme Göre (A-Z)</option>
                <option value="date_desc">Eklenme Tarihi (Yeni)</option>
                <option value="date_asc">Eklenme Tarihi (Eski)</option>
            </select>
            <div class="col-span-full md:col-span-4 mt-4 flex flex-col sm:flex-row gap-4">
                <button id="toggle-form-btn" class="btn btn-primary w-full sm:w-auto"><span id="toggle-form-icon" class="material-symbols-outlined">add</span><span id="toggle-form-text">Yeni Kayıt</span></button>
                <a href="index.html" rel="noopener noreferrer" class="btn btn-secondary w-full sm:w-auto"><span class="material-symbols-outlined">visibility</span><span>Galeriye Git</span></a>
                <button id="fusion-report-btn" class="btn btn-secondary w-full sm:w-auto"><span class="material-symbols-outlined">analytics</span><span>Füzyon Raporu</span></button>
            </div>
        </div>
        
        <div id="add-edit-form-container" class="bg-[var(--md-sys-color-surface-container)] rounded-2xl p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold mb-4">Yeni Kayıt Ekle</h2>
            <form id="add-form" class="flex flex-col gap-4">
                <select id="add-item-type-select" name="itemType" class="form-select"><option value="character">Normal Karakter</option><option value="fusion">Füzyon</option><option value="easterEgg">Easter Egg</option></select>
                <input required type="text" name="id" placeholder="Kayıt ID (benzersiz olmalı)" class="form-input">
                <input required type="text" name="name" placeholder="İsim" class="form-input">
                
                <div class="image-input-container border-t border-[var(--md-sys-color-outline-variant)] pt-4">
                    <label class="block text-sm font-medium mb-2" data-label-text="Ana Resim">Ana Resim</label>
                    <div class="flex items-center gap-4 mb-2">
                        <label class="flex items-center gap-2"><input type="radio" name="imageSource_0" value="file" checked class="form-radio image-source-toggle"> Dosya Yükle</label>
                        <label class="flex items-center gap-2"><input type="radio" name="imageSource_0" value="url" class="form-radio image-source-toggle"> Link Ver</label>
                    </div>
                    <div class="file-input-wrapper"><input type="file" name="imageFile" class="form-input"></div>
                    <div class="url-input-wrapper"><input type="text" name="imageUrl" placeholder="Resim linkini buraya yapıştırın..." class="form-input"></div>
                </div>
                
                <div id="add-character-fields" class="flex flex-col gap-4">
                    <div class="image-input-container border-t border-[var(--md-sys-color-outline-variant)] pt-4">
                        <label class="block text-sm font-medium mb-2">2★ Resim</label>
                         <div class="flex items-center gap-4 mb-2">
                            <label class="flex items-center gap-2"><input type="radio" name="imageSource_1" value="file" checked class="form-radio image-source-toggle"> Dosya Yükle</label>
                            <label class="flex items-center gap-2"><input type="radio" name="imageSource_1" value="url" class="form-radio image-source-toggle"> Link Ver</label>
                        </div>
                        <div class="file-input-wrapper"><input type="file" name="evolutions_1_file" class="form-input"></div>
                        <div class="url-input-wrapper"><input type="text" name="evolutions_1_url" placeholder="Resim linkini buraya yapıştırın..." class="form-input"></div>
                    </div>
                    <div class="image-input-container border-t border-[var(--md-sys-color-outline-variant)] pt-4">
                        <label class="block text-sm font-medium mb-2">3★ Resim</label>
                         <div class="flex items-center gap-4 mb-2">
                            <label class="flex items-center gap-2"><input type="radio" name="imageSource_2" value="file" checked class="form-radio image-source-toggle"> Dosya Yükle</label>
                            <label class="flex items-center gap-2"><input type="radio" name="imageSource_2" value="url" class="form-radio image-source-toggle"> Link Ver</label>
                        </div>
                        <div class="file-input-wrapper"><input type="file" name="evolutions_2_file" class="form-input"></div>
                        <div class="url-input-wrapper"><input type="text" name="evolutions_2_url" placeholder="Resim linkini buraya yapıştırın..." class="form-input"></div>
                    </div>
                </div>
                
                <div id="add-fusion-fields" class="hidden flex flex-col gap-3">
                    <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 1</label>
                        <div class="flex items-center gap-2"><div id="add_fusionPartners_0_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('add_fusionPartners_0')">Seç</button><input type="hidden" name="fusionPartners_0"></div>
                    </div>
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 2</label>
                        <div class="flex items-center gap-2"><div id="add_fusionPartners_1_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('add_fusionPartners_1')">Seç</button><input type="hidden" name="fusionPartners_1"></div>
                    </div>
                </div>
                <div id="add-fusion-preview-image-field" class="hidden image-input-container border-t border-[var(--md-sys-color-outline-variant)] pt-4">
                    <label class="block text-sm font-medium mb-2">Füzyon Önizleme Resmi (PNG/JPG)</label>
                    <div class="flex items-center gap-4 mb-2">
                        <label class="flex items-center gap-2"><input type="radio" name="imageSource_3" value="file" checked class="form-radio image-source-toggle"> Dosya Yükle</label>
                        <label class="flex items-center gap-2"><input type="radio" name="imageSource_3" value="url" class="form-radio image-source-toggle"> Link Ver</label>
                    </div>
                    <div class="file-input-wrapper"><input type="file" name="fusion_preview_file" class="form-input"></div>
                    <div class="url-input-wrapper"><input type="text" name="fusion_preview_url" placeholder="Resim linkini buraya yapıştırın..." class="form-input"></div>
                </div>

                <div id="add-easter-egg-fields" class="hidden flex flex-col gap-3">
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Orijinal Karakter</label>
                        <div class="flex items-center gap-2"><div id="add_originalCharacterId_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('add_originalCharacterId')">Seç</button><input type="hidden" name="originalCharacterId"></div>
                    </div>
                </div>
                
                <div class="border-t border-[var(--md-sys-color-outline-variant)] pt-4 mt-2 upload-service-chooser">
                    <label class="block text-sm font-medium mb-2">Dosya Yükleme Servisi</label>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2"><input type="radio" name="uploadService" value="imgbb" checked class="form-radio"> ImgBB</label>
                        <label class="flex items-center gap-2"><input type="radio" name="uploadService" value="vgyme" class="form-radio"> VGY.ME</label>
                    </div>
                </div>

                <div class="flex gap-4 mt-4"><button type="button" id="cancel-add-button" class="btn btn-secondary flex-grow">İptal</button><button type="submit" class="btn btn-primary flex-grow">Kaydet</button></div>
            </form>
        </div>

        <main>
            <h2 class="text-2xl font-bold mb-4">Mevcut Kayıtlar</h2>
            <div id="admin-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            <p id="no-results" class="text-center text-lg mt-8 hidden" style="color: var(--md-sys-color-on-surface-variant);">Hiçbir kayıt bulunamadı.</p>
        </main>
    </div>

    <div id="login-modal" class="modal-backdrop hidden" onclick="closeLoginModal()"><div class="modal-content !max-w-sm" onclick="event.stopPropagation()"><button class="icon-button absolute top-2 right-2" onclick="closeLoginModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button><h2 class="text-2xl font-bold mb-4 text-center">Yönetici Girişi</h2><div class="flex flex-col gap-3"><input type="email" id="admin-email" placeholder="E-posta" class="form-input"><input type="password" id="admin-password" placeholder="Şifre" class="form-input"><button id="login-submit-btn" class="btn btn-success w-full mt-2">Giriş Yap</button><p id="login-status" class="mt-2 text-center text-red-400 h-5"></p></div></div></div>
    <div id="enlarged-image-overlay" class="enlarged-image-container hidden" onclick="closeEnlargedImage()"><button class="icon-button absolute top-4 right-4 text-white text-4xl z-10" onclick="closeEnlargedImage(event)" aria-label="Resmi Kapat"><span class="material-symbols-outlined" style="font-size: 36px;">close</span></button><img id="enlarged-image" src="" alt="Büyük Resim" class="enlarged-image"></div>
    <div id="character-selector-modal" class="modal-backdrop hidden" onclick="closeCharacterSelector()"><div class="modal-content !max-w-screen-sm" onclick="event.stopPropagation()"><button class="icon-button absolute top-2 right-2" onclick="closeCharacterSelector()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button><h2 class="text-2xl font-bold mb-4">Karakter Seç</h2><input type="text" id="selector-search-input" placeholder="Karakter ara..." class="form-input mb-4"><div id="selector-grid" class="max-h-96 overflow-y-auto pr-2 flex flex-col gap-2"></div></div></div>
    <div id="report-modal" class="modal-backdrop hidden" onclick="closeReportModal()"><div class="modal-content !max-w-screen-md report-modal-content" onclick="event.stopPropagation()"><button class="icon-button absolute top-2 right-2" onclick="closeReportModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button><h2 id="report-title" class="text-2xl font-bold mb-4 text-center" style="color: var(--md-sys-color-primary);">Rapor</h2><div id="report-content" class="max-h-[70vh] overflow-y-auto pr-2"></div></div></div>
    
    <div id="edit-modal" class="modal-backdrop hidden">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="icon-button absolute top-2 right-2" onclick="closeEditModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button>
            <h2 class="text-2xl font-bold mb-4">Kaydı Düzenle</h2>
            <form id="edit-form" class="flex flex-col gap-4">
                <input type="hidden" name="itemType">
                <input type="hidden" name="id">

                <div>
                    <label class="block text-sm font-medium mb-1">İsim</label>
                    <input required type="text" name="name" placeholder="İsim" class="form-input">
                </div>
                 <div>
                    <label class="block text-sm font-medium mb-1">Eklenme Tarihi</label>
                    <input type="date" name="eklenmeTarihi" class="form-input">
                </div>
                
                <div id="edit-image-fields" class="flex flex-col gap-4"></div>

                <div id="edit-fusion-fields" class="hidden flex flex-col gap-3">
                    <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 1</label>
                        <div class="flex items-center gap-2"><div id="edit_fusionPartners_0_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('edit_fusionPartners_0')">Seç</button><input type="hidden" name="fusionPartners_0"></div>
                    </div>
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 2</label>
                        <div class="flex items-center gap-2"><div id="edit_fusionPartners_1_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('edit_fusionPartners_1')">Seç</button><input type="hidden" name="fusionPartners_1"></div>
                    </div>
                </div>
                <div id="edit-easter-egg-fields" class="hidden flex flex-col gap-3">
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Orijinal Karakter</label>
                        <div class="flex items-center gap-2"><div id="edit_originalCharacterId_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('edit_originalCharacterId')">Seç</button><input type="hidden" name="originalCharacterId"></div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-4"><button type="button" class="btn btn-secondary flex-grow" onclick="closeEditModal()">İptal</button><button type="submit" class="btn btn-primary flex-grow">Güncelle</button></div>
            </form>
        </div>
    </div>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrEU_QEuvf960ZPxo29n6x8N9K7yGIkCQ",
            authDomain: "karaktergalerisi-dc337.firebaseapp.com",
            projectId: "karaktergalerisi-dc337",
            storageBucket: "karaktergalerisi-dc337.firebasestorage.app",
            messagingSenderId: "486669559067",
            appId: "1:486669559067:web:20c76a78a41d9bc0bbdfbe"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null, vgyme_user_key: null };
        let characters = [], easterEggs = [], dismissed = [];
        let editingItemData = null; 
        let selectorTargetInput = null;

        const viewState = { filter: 'all', sortBy: 'name_asc' };
        const dom = {};

        const openLoginModal = () => { dom.loginModal.classList.remove('hidden'); dom.loginModal.classList.add('visible'); };
        const closeLoginModal = () => { dom.loginModal.classList.add('hidden'); dom.loginModal.classList.remove('visible'); };
        const openReportModal = () => { dom.reportModal.classList.remove('hidden'); dom.reportModal.classList.add('visible'); };
        const closeReportModal = () => {
            dom.reportModal.classList.add('hidden');
            dom.reportModal.classList.remove('visible');
            if (dom.viewFilter.value === 'preview-report') {
                dom.viewFilter.value = 'all';
                viewState.filter = 'all';
            }
        };
        const openEditModal = () => { dom.editModal.classList.remove('hidden'); dom.editModal.classList.add('visible'); };
        const closeEditModal = () => { dom.editModal.classList.add('hidden'); dom.editModal.classList.remove('visible'); editingItemData = null; };
        
        const getStarEmojis = (isFusion, starCount, iconName = 'star') => {
            const colors = { 1: 'text-orange-400', 2: 'text-slate-400', 3: 'text-amber-400', 4: 'text-fuchsia-400' };
            const starIcon = `<span class="material-symbols-outlined ${colors[isFusion ? 4 : Math.min(starCount, 4)]}" style="font-variation-settings: 'FILL' 1;">${iconName}</span>`;
            return `<div class="flex">${Array(starCount || 1).fill(starIcon).join('')}</div>`;
        };

        function openCharacterSelector(targetId) {
            selectorTargetInput = targetId;
            renderCharacterSelector();
            dom.characterSelectorModal.classList.remove('hidden');
            dom.characterSelectorModal.classList.add('visible');
            dom.selectorSearchInput.focus();
        }

        function closeCharacterSelector() {
            dom.characterSelectorModal.classList.add('hidden');
            dom.characterSelectorModal.classList.remove('visible');
            dom.selectorSearchInput.value = '';
            selectorTargetInput = null;
        }

        function renderCharacterSelector(query = '') {
            dom.selectorGrid.innerHTML = '';
            const searchableChars = characters.filter(c => !c.isFusion);
            const filtered = searchableChars.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
            
            if (filtered.length === 0) {
                dom.selectorGrid.innerHTML = `<p class="text-center text-gray-400">Karakter bulunamadı.</p>`;
                return;
            }

            filtered.forEach(char => {
                const item = document.createElement('div');
                item.className = 'character-selector-item';
                item.innerHTML = `
                    <img src="${char.imageUrl}" alt="${char.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-bold">${char.name}</p>
                        <p class="text-sm text-gray-400">ID: ${char.id}</p>
                    </div>
                `;
                item.onclick = () => selectCharacter(char);
                dom.selectorGrid.appendChild(item);
            });
        }

        function selectCharacter(char) {
            if (!selectorTargetInput) return;
            const displayEl = document.getElementById(`${selectorTargetInput}_display`);
            const hiddenInput = document.querySelector(`[name="${selectorTargetInput.split('_')[1]}"]`);
            
            displayEl.textContent = char.name;
            displayEl.classList.remove('italic', 'text-gray-400');
            hiddenInput.value = char.id;
            
            closeCharacterSelector();
        }
        
        function renderAdminPanel() {
            dom.adminGrid.innerHTML = '';
            const query = dom.searchInput.value.toLowerCase().trim();
            let allItems = [...characters, ...easterEggs, ...dismissed];
            
            if (viewState.filter === 'available') {
                const fusionPartnerIds = new Set(characters.filter(c => c.isFusion).flatMap(f => f.fusionPartners));
                allItems = characters.filter(c => !c.isFusion && !fusionPartnerIds.has(c.id));
            }

            const getDate = (item) => item.eklenmeTarihi ? item.eklenmeTarihi.toDate() : new Date(0);
            allItems.sort((a, b) => {
                switch (viewState.sortBy) {
                    case 'date_desc': return getDate(b) - getDate(a);
                    case 'date_asc': return getDate(a) - getDate(b);
                    case 'name_asc': default: return a.name.localeCompare(b.name, 'tr');
                }
            });

            const filteredItems = allItems.filter(item => item.name.toLowerCase().includes(query) || item.id.toLowerCase().includes(query));
            dom.noResults.classList.toggle('hidden', filteredItems.length > 0);
            
            filteredItems.forEach(item => {
                const card = document.createElement('div');
                const isRetired = item.isRetired || false;
                card.className = `item-card ${isRetired ? 'retired' : ''}`;
                const isFusion = item.isFusion, isEasterEgg = item.originalCharacterId, nameClass = isFusion || isEasterEgg ? 'font-fantastical-fusion' : '';
                let imageBlockHtml;
                if(isFusion || isEasterEgg) {
                    imageBlockHtml = `<div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover"></div>`;
                } else {
                    const evo2 = item.evolutions?.find(e => e.star === 2), evo3 = item.evolutions?.find(e => e.star === 3);
                    const thumbClass = "w-12 h-12 flex-shrink-0 rounded-md overflow-hidden bg-black/20 border border-white/10 flex items-center justify-center", placeholderClass = "text-sm font-bold text-gray-500", imgClass = "w-full h-full object-cover cursor-zoom-in";
                    imageBlockHtml = `<div class="flex items-center gap-3"><div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name} 1★" class="${imgClass}"></div><div class="flex flex-col gap-1.5"><div class="${thumbClass}" onclick="${evo2 ? `enlargeImage(event, '${evo2.imageUrl}')` : ''}">${evo2 ? `<img src="${evo2.imageUrl}" alt="${item.name} 2★" class="${imgClass}">` : `<span class="${placeholderClass}">2★</span>`}</div><div class="${thumbClass}" onclick="${evo3 ? `enlargeImage(event, '${evo3.imageUrl}')` : ''}">${evo3 ? `<img src="${evo3.imageUrl}" alt="${item.name} 3★" class="${imgClass}">` : `<span class="${placeholderClass}">3★</span>`}</div></div></div>`;
                }
                let starHtml;
                if(isFusion) starHtml = getStarEmojis(true, 4); else if (isEasterEgg) starHtml = getStarEmojis(false, 1, 'auto_awesome'); else starHtml = getStarEmojis(false, 1);
                let actionButtonsHtml;
                if (isRetired) {
                    actionButtonsHtml = `<button class="icon-button retire-button" data-id="${item.id}" data-type="${item.type}" data-action="unretire" aria-label="Geri Al"><span class="material-symbols-outlined">settings_backup_restore</span></button><button class="icon-button delete-button" data-id="${item.id}" data-type="${item.type}" aria-label="Kalıcı Olarak Sil"><span class="material-symbols-outlined">delete_forever</span></button>`;
                } else {
                    actionButtonsHtml = `<button class="icon-button retire-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" data-action="retire" aria-label="Emekliye Ayır"><span class="material-symbols-outlined">work_history</span></button><button class="icon-button edit-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Düzenle"><span class="material-symbols-outlined">edit</span></button><button class="icon-button delete-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Sil"><span class="material-symbols-outlined">delete</span></button>`;
                }
                const retiredBadge = isRetired ? `<p class="text-xs font-bold mt-1" style="color: var(--md-sys-color-warning);">EMEKLİ</p>` : '';
                const dateHtml = item.eklenmeTarihi ? `<p class="text-xs text-gray-400 mt-1">${getDate(item).toLocaleDateString('tr-TR')}</p>` : '<p class="text-xs text-red-400 mt-1">Tarih Yok</p>';
                card.innerHTML = `${imageBlockHtml}<div class="flex-grow"><h4 class="font-bold text-lg truncate ${nameClass}">${item.name}</h4><p class="text-sm text-gray-400">ID: ${item.id}</p><div class="flex mt-1">${starHtml}</div>${dateHtml}${retiredBadge}</div><div class="flex-shrink-0 flex flex-col gap-1">${actionButtonsHtml}</div>`;
                dom.adminGrid.appendChild(card);
            });
            setupActionListeners();
        }
        
        function resetAddForm() {
            dom.addForm.reset();
            dom.addForm.querySelector('#add-item-type-select').value = 'character';
            toggleAddFormFields();
            document.querySelectorAll('#add-form .image-input-container').forEach(container => {
                container.querySelector('.file-input-wrapper').style.display = 'block';
                container.querySelector('.url-input-wrapper').style.display = 'none';
                container.querySelectorAll('.image-source-toggle').forEach(radio => {
                    if (radio.value === 'file') radio.checked = true;
                });
            });
            ['add_fusionPartners_0', 'add_fusionPartners_1', 'add_originalCharacterId'].forEach(id => {
                const display = document.getElementById(`${id}_display`);
                if (display) {
                    display.textContent = 'Seçilmedi';
                    display.classList.add('italic', 'text-gray-400');
                }
            });
            updateUploadServiceVisibility(dom.addForm);
        }
        
        function updateAuthUI(user) {
            const contentToLock = [dom.appContainer.querySelector('main'), dom.toggleFormBtn.closest('.flex'), dom.addEditFormContainer, dom.viewFilter, dom.sortBy, dom.searchInput, dom.fusionReportBtn];
            if (user) {
                dom.authActionText.textContent = 'Çıkış Yap'; dom.authActionIcon.textContent = 'logout';
                dom.authActionBtn.onclick = () => { if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) firebase.auth().signOut(); };
                closeLoginModal();
                fetchApiKeys().then(success => contentToLock.forEach(el => { if(el) { el.style.opacity = success ? '1' : '0.5'; el.style.pointerEvents = success ? 'auto' : 'none'; }}));
            } else {
                dom.authActionText.textContent = 'Giriş Yap'; dom.authActionIcon.textContent = 'login';
                dom.authActionBtn.onclick = openLoginModal;
                apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null, vgyme_user_key: null };
                contentToLock.forEach(el => { if(el) { el.style.opacity = '0.5'; el.style.pointerEvents = 'none'; }});
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
            }
        }
        
        const toggleAddFormFields = function() {
            const selectedType = dom.addForm.elements.itemType.value;
            dom.addForm.querySelector('#add-character-fields').classList.toggle('hidden', selectedType !== 'character');
            dom.addForm.querySelector('#add-fusion-fields').classList.toggle('hidden', selectedType !== 'fusion');
            dom.addForm.querySelector('#add-fusion-preview-image-field').classList.toggle('hidden', selectedType !== 'fusion');
            dom.addForm.querySelector('#add-easter-egg-fields').classList.toggle('hidden', selectedType !== 'easterEgg');
            const mainImageLabel = dom.addForm.querySelector('.image-input-container [data-label-text]');
            mainImageLabel.textContent = selectedType === 'easterEgg' ? 'Easter Egg Resim' : (selectedType === 'fusion' ? 'Ana Füzyon Resmi (GIF)' : 'Ana Resim');
        };

        const setupActionListeners = function() {
            dom.adminGrid.querySelectorAll('.edit-button, .delete-button, .retire-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { id, type, action } = e.currentTarget.dataset;
                    if (button.classList.contains('edit-button')) { openItemForEdit(id, type); }
                    else if (button.classList.contains('delete-button')) { deleteItem(id, type); }
                    else if (button.classList.contains('retire-button')) {
                        if (action === 'retire') { retireItem(id, type); } else if (action === 'unretire') { unretireItem(id, type); }
                    }
                });
            });
        };
        
        const uploadImageToImgBB = async function(file, apiKey) {
            if (!file) return null; if (!apiKey) { throw new Error("ImgBB API anahtarı eksik."); }
            const formData = new FormData(); formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error(`Yükleme hatası: ${res.statusText}`);
                const result = await res.json();
                if (result.success) return result.data.url; else throw new Error(result.error.message);
            } catch (error) { alert(`Resim yüklenemedi: ${error.message}`); return null; }
        };

        const uploadImageToVgyme = async function(file, userKey) {
            if (!file) return null;
            if (!userKey) { throw new Error("VGY.ME kullanıcı anahtarı eksik."); }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userkey', userKey);
            try {
                const res = await fetch('https://vgy.me/upload', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(`VGY.ME Yükleme hatası: ${res.statusText}`);
                const result = await res.json();
                if (!result.error) return result.image; else throw new Error(result.message);
            } catch (error) { alert(`VGY.ME'ye resim yüklenemedi: ${error.message}`); return null; }
        };

        async function processImageInput(form, sourceName, fileInputName, urlInputName, currentUrl = null) {
            const sourceRadio = form.elements[sourceName];
            if (!sourceRadio || !sourceRadio[0].checked && !sourceRadio[1].checked) return currentUrl; 
            
            const source = sourceRadio.value;
            
            if (source === 'url') {
                const url = form.elements[urlInputName].value.trim();
                return url || currentUrl; 
            } 
            
            if (source === 'file') {
                const file = form.elements[fileInputName]?.files[0];
                if (!file) return currentUrl;

                const selectedService = form.elements['uploadService'].value;
                
                if (selectedService === 'vgyme') {
                    if (!apiKeys.vgyme_user_key) throw new Error("Firestore'da VGY.ME kullanıcı anahtarı bulunamadı.");
                    return await uploadImageToVgyme(file, apiKeys.vgyme_user_key);
                } else { 
                    const isEasterEggUpload = editingItemData ? editingItemData.originalCharacterId !== undefined : form.elements.itemType.value === 'easterEgg';
                    const apiKey = (fileInputName.startsWith('imageFile') && isEasterEggUpload) ? apiKeys.imgbb_easteregg_key : apiKeys.imgbb_main_key;
                    if (!apiKey) throw new Error("Firestore'da ImgBB API anahtarı bulunamadı.");
                    return await uploadImageToImgBB(file, apiKey);
                }
            }
            return currentUrl;
        }

        const handleAddFormSubmit = async function(event) {
            event.preventDefault(); 
            const form = dom.addForm; 
            const id = form.elements['id'].value.trim();
            if (!id || !firebase.auth().currentUser) {
                return alert(!id ? "ID boş olamaz." : "Giriş yapmalısınız.");
            }
            
            const saveButton = form.querySelector('button[type="submit"]');
            saveButton.textContent = 'Yükleniyor...'; 
            saveButton.disabled = true;

            try {
                const type = form.elements.itemType.value;
                let data = { 
                    name: form.elements['name'].value.trim(),
                    eklenmeTarihi: firebase.firestore.FieldValue.serverTimestamp()
                };
                let collectionName = type === 'easterEgg' ? 'easterEggs' : 'characters';

                switch (type) {
                    case 'character':
                        data.isFusion = false; data.star = 1;
                        const [mainUrl, evo1Url, evo2Url] = await Promise.all([
                            processImageInput(form, 'imageSource_0', 'imageFile', 'imageUrl'),
                            processImageInput(form, 'imageSource_1', 'evolutions_1_file', 'evolutions_1_url'),
                            processImageInput(form, 'imageSource_2', 'evolutions_2_file', 'evolutions_2_url')
                        ]);
                        if (!mainUrl) throw new Error("Ana resim linki veya dosyası zorunludur.");
                        data.imageUrl = mainUrl; data.evolutions = [];
                        if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                        if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });
                        break;
                    case 'fusion':
                        data.isFusion = true; data.star = 4;
                        const [fusionMainUrl, previewUrl] = await Promise.all([
                            processImageInput(form, 'imageSource_0', 'imageFile', 'imageUrl'),
                            processImageInput(form, 'imageSource_3', 'fusion_preview_file', 'fusion_preview_url')
                        ]);
                        if (!fusionMainUrl) throw new Error("Ana füzyon resmi linki veya dosyası zorunludur.");
                        data.imageUrl = fusionMainUrl; data.previewUrl = previewUrl;
                        data.fusionPartners = [form.elements['fusionPartners_0'].value.trim(), form.elements['fusionPartners_1'].value.trim()].filter(Boolean);
                        break;
                    case 'easterEgg':
                        const eeMainUrl = await processImageInput(form, 'imageSource_0', 'imageFile', 'imageUrl');
                        if (!eeMainUrl) throw new Error("Easter Egg resmi linki veya dosyası zorunludur.");
                        data.imageUrl = eeMainUrl;
                        data.originalCharacterId = form.elements['originalCharacterId'].value.trim();
                        break;
                }
                
                await db.collection(collectionName).doc(id).set(data, { merge: true });
                alert(`Kayıt başarıyla kaydedildi!`);
                await fetchItems(); 
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; 
                dom.toggleFormIcon.textContent = 'add'; 
                resetAddForm();
            } catch (error) { 
                alert(`Hata: ${error.message}`); 
            } finally {
                saveButton.textContent = 'Kaydet';
                saveButton.disabled = false;
            }
        };

        const deleteItem = async function(itemId, itemType) {
            const isRetired = dismissed.some(i => i.id === itemId);
            const collectionName = isRetired ? 'dismissed' : (itemType === 'easterEgg' ? 'easterEggs' : 'characters');
            const item = [...characters, ...easterEggs, ...dismissed].find(i => i.id === itemId);
            if (!item || !confirm(`'${item.name}' adlı kaydı ${isRetired ? 'KALICI OLARAK' : ''} silmek istediğinizden emin misiniz?`)) return;
            try {
                if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
                await db.collection(collectionName).doc(itemId).delete();
                alert("Kayıt silindi."); await fetchItems();
            } catch (error) { alert(`Silme hatası: ${error.message}`); }
        };

        const retireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı emekliye ayırmak istediğinizden emin misiniz?")) return; if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
            const sourceCollection = itemType === 'easterEgg' ? 'easterEggs' : 'characters'; const itemRef = db.collection(sourceCollection).doc(itemId);
            try {
                const doc = await itemRef.get(); if (!doc.exists) throw new Error("Taşınacak kayıt bulunamadı.");
                await db.collection('dismissed').doc(itemId).set({ ...doc.data(), type: itemType }); await itemRef.delete();
                alert("Kayıt başarıyla emekliye ayrıldı."); await fetchItems();
            } catch (error) { alert(`Emekliye ayırma hatası: ${error.message}`); }
        };

        const unretireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı tekrar aktif hale getirmek istediğinizden emin misiniz?")) return; if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
            const dismissedRef = db.collection('dismissed').doc(itemId);
            try {
                const doc = await dismissedRef.get(); if (!doc.exists) throw new Error("Geri alınacak kayıt bulunamadı.");
                let itemData = doc.data(); const originalType = itemData.type || 'character';
                const destinationCollection = originalType === 'easterEgg' ? 'easterEggs' : 'characters'; delete itemData.type;
                await db.collection(destinationCollection).doc(itemId).set(itemData); await dismissedRef.delete();
                alert("Kayıt tekrar aktifleştirildi."); await fetchItems();
            } catch (error) { alert(`Geri alma hatası: ${error.message}`); }
        };
        
        const fetchItems = async function() {
            try {
                const [charsSnap, eeSnap, dismissedSnap] = await Promise.all([ db.collection('characters').get(), db.collection('easterEggs').get(), db.collection('dismissed').get() ]);
                characters = charsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                easterEggs = eeSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dismissed = dismissedSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), isRetired: true }));
                renderAdminPanel();
            } catch (error) { 
                console.error("Veri çekme hatası:", error);
                dom.adminGrid.innerHTML = `<p class="col-span-full text-center text-lg text-red-500">Veriler çekilemedi. Lütfen konsolu kontrol edin.</p>`;
            }
        };

        const enlargeImage = function(event, src) { if(event) event.stopPropagation(); if(src) {dom.enlargedImage.src = src; dom.enlargedImageOverlay.classList.remove('hidden');} };
        const closeEnlargedImage = function(event) { if (event) event.stopPropagation(); dom.enlargedImageOverlay.classList.add('hidden'); };
        
        const fetchApiKeys = async function() {
            try {
                const apiKeysDoc = await db.collection('settings').doc('apiKeys').get();
                if (apiKeysDoc.exists) { 
                    Object.assign(apiKeys, apiKeysDoc.data());
                    return true; 
                }
                else { alert("Yönetici API anahtarları bulunamadı."); return false; }
            } catch (error) { alert("API anahtarları çekilemedi."); return false; }
        };

        function generateFusionReport() {
            if (typeof characters === 'undefined' || characters.length === 0) {
                return '<p class="text-red-400">Hata: Karakter verisi bulunamadı veya henüz yüklenmedi.</p>';
            }
            const aktifKarakterler = [...characters]; 
            const normalKarakterler = aktifKarakterler.filter(k => !k.isFusion);
            const fuzyonlar = aktifKarakterler.filter(k => k.isFusion);
            const fuzyonKatilimSayilari = {};
            normalKarakterler.forEach(karakter => { fuzyonKatilimSayilari[karakter.name] = 0; });
            fuzyonlar.forEach(fuzyon => {
                fuzyon.fusionPartners.forEach(partnerId => {
                    const partnerKarakter = normalKarakterler.find(k => k.id === partnerId);
                    if (partnerKarakter) {
                        if (fuzyonKatilimSayilari[partnerKarakter.name] === undefined) { fuzyonKatilimSayilari[partnerKarakter.name] = 0; }
                        fuzyonKatilimSayilari[partnerKarakter.name]++;
                    }
                });
            });
            let html = '<h3>Karakterlerin Füzyon Katılım Sayıları</h3><ul>';
            for (const karakterAdi in fuzyonKatilimSayilari) {
                html += `<li>- ${karakterAdi}: <strong>${fuzyonKatilimSayilari[karakterAdi]}</strong> füzyona katılmış.</li>`;
            }
            html += '</ul>';
            html += '<h3>Füzyon Listesi</h3>';
            if (fuzyonlar.length > 0) {
                html += '<ul>';
                fuzyonlar.forEach(fuzyon => { html += `<li>- ${fuzyon.name}</li>`; });
                html += '</ul>';
            } else { html += '<p>Aktif füzyon bulunamadı.</p>'; }
            html += '<h3>Füzyonlar ve Katılan Karakterler</h3>';
            if (fuzyonlar.length > 0) {
                html += '<ul>';
                fuzyonlar.forEach(fuzyon => {
                    const partnerIsimleri = fuzyon.fusionPartners.map(partnerId => {
                        const partner = normalKarakterler.find(k => k.id === partnerId);
                        return partner ? partner.name : "<em>Bilinmeyen Karakter</em>";
                    }).join(' + ');
                    html += `<li>- ${fuzyon.name}: [${partnerIsimleri}]</li>`;
                });
                html += '</ul>';
            } else { html += '<p>Detayları gösterilecek aktif füzyon bulunamadı.</p>'; }
            return html;
        }

        function updateUploadServiceVisibility(form) {
            const uploadServiceChooser = form.querySelector('.upload-service-chooser');
            if (!uploadServiceChooser) return;
            let anyFileSelected = false;
            form.querySelectorAll('.image-source-toggle[value="file"]:checked').forEach(radio => {
                const container = radio.closest('.image-input-container, .image-edit-container');
                if (container && container.style.display !== 'none' && !container.classList.contains('hidden')) {
                    anyFileSelected = true;
                }
            });
            uploadServiceChooser.style.display = anyFileSelected ? 'block' : 'none';
        }

        function createImageEditField(label, currentUrl, fieldName) {
            const hasUrl = currentUrl && currentUrl.trim() !== '';
            return `
                <div class="image-edit-container border-t border-[var(--md-sys-color-outline-variant)] pt-4">
                    <label class="block text-sm font-medium mb-2">${label}</label>
                    <div class="flex items-center gap-4">
                        <img src="${hasUrl ? currentUrl : 'https://via.placeholder.com/96x96.png?text=Yok'}" class="w-24 h-24 object-cover rounded-md bg-gray-700">
                        <div class="flex-grow">
                            <p class="text-xs break-all text-gray-400">${hasUrl ? currentUrl : 'Resim Yok'}</p>
                            <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="toggleEditUploader(this)">Değiştir</button>
                        </div>
                    </div>
                    <div class="edit-image-uploader mt-3">
                        <input type="hidden" name="${fieldName}_current" value="${currentUrl || ''}">
                        <div class="flex items-center gap-4 mb-2">
                            <label class="flex items-center gap-2"><input type="radio" name="${fieldName}_source" value="file" checked class="form-radio image-source-toggle"> Dosya Yükle</label>
                            <label class="flex items-center gap-2"><input type="radio" name="${fieldName}_source" value="url" class="form-radio image-source-toggle"> Link Ver</label>
                        </div>
                        <div class="file-input-wrapper"><input type="file" name="${fieldName}_file" class="form-input"></div>
                        <div class="url-input-wrapper"><input type="text" name="${fieldName}_url" placeholder="Yeni resim linkini buraya yapıştırın..." class="form-input"></div>
                         <div class="upload-service-chooser mt-2">
                            <label class="block text-sm font-medium mb-2">Yükleme Servisi</label>
                            <div class="flex items-center gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="uploadService" value="imgbb" checked class="form-radio"> ImgBB</label>
                                <label class="flex items-center gap-2"><input type="radio" name="uploadService" value="vgyme" class="form-radio"> VGY.ME</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleEditUploader(button) {
            const uploader = button.closest('.image-edit-container').querySelector('.edit-image-uploader');
            uploader.style.display = uploader.style.display === 'none' ? 'block' : 'none';
        }

        async function openItemForEdit(itemId, itemType) {
            const allItems = [...characters, ...easterEggs, ...dismissed];
            const itemData = allItems.find(i => i.id === itemId);
            if (!itemData) return alert("Kayıt bulunamadı.");
            editingItemData = itemData;

            const form = dom.editForm;
            form.reset();
            form.elements.id.value = itemData.id;
            form.elements.itemType.value = itemType;
            form.elements.name.value = itemData.name || '';
            if (itemData.eklenmeTarihi) {
                const date = itemData.eklenmeTarihi.toDate();
                form.elements.eklenmeTarihi.value = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
            } else {
                form.elements.eklenmeTarihi.value = '';
            }
            
            const imageFieldsContainer = dom.editForm.querySelector('#edit-image-fields');
            imageFieldsContainer.innerHTML = '';

            let imageFieldsHtml = createImageEditField('Ana Resim (1★)', itemData.imageUrl, 'imageUrl');
            
            if (itemType === 'character') {
                const evo1 = itemData.evolutions?.find(e => e.star === 2) || {};
                const evo2 = itemData.evolutions?.find(e => e.star === 3) || {};
                imageFieldsHtml += createImageEditField('2★ Resim', evo1.imageUrl, 'evolutions_1');
                imageFieldsHtml += createImageEditField('3★ Resim', evo2.imageUrl, 'evolutions_2');
            } else if (itemType === 'fusion') {
                imageFieldsHtml += createImageEditField('Önizleme Resmi', itemData.previewUrl, 'previewUrl');
            }
            imageFieldsContainer.innerHTML = imageFieldsHtml;

            dom.editForm.querySelector('#edit-fusion-fields').classList.toggle('hidden', itemType !== 'fusion');
            dom.editForm.querySelector('#edit-easter-egg-fields').classList.toggle('hidden', itemType !== 'easterEgg');

            const updateSelectorDisplay = (prefix, inputId, charId) => {
                const character = characters.find(c => c.id === charId);
                const display = document.getElementById(`${prefix}_${inputId}_display`);
                const input = form.elements[inputId];
                if (character && display && input) {
                    display.textContent = character.name;
                    display.classList.remove('italic', 'text-gray-400');
                    input.value = character.id;
                }
            };
            if (itemType === 'fusion') {
                updateSelectorDisplay('edit', 'fusionPartners_0', itemData.fusionPartners?.[0]);
                updateSelectorDisplay('edit', 'fusionPartners_1', itemData.fusionPartners?.[1]);
            } else if (itemType === 'easterEgg') {
                updateSelectorDisplay('edit', 'originalCharacterId', itemData.originalCharacterId);
            }
            
            openEditModal();
        }

        async function handleEditFormSubmit(event) {
            event.preventDefault();
            const form = dom.editForm;
            const saveButton = form.querySelector('button[type="submit"]');
            saveButton.textContent = 'Güncelleniyor...';
            saveButton.disabled = true;

            try {
                const id = form.elements.id.value;
                const type = form.elements.itemType.value;
                let data = {
                    name: form.elements.name.value.trim(),
                    eklenmeTarihi: firebase.firestore.Timestamp.fromDate(new Date(form.elements.eklenmeTarihi.value))
                };
                let collectionName = type === 'easterEgg' ? 'easterEggs' : 'characters';

                if (type === 'character') {
                    const [mainUrl, evo1Url, evo2Url] = await Promise.all([
                        processImageInput(form, 'imageUrl_source', 'imageUrl_file', 'imageUrl_url', form.elements.imageUrl_current.value),
                        processImageInput(form, 'evolutions_1_source', 'evolutions_1_file', 'evolutions_1_url', form.elements.evolutions_1_current.value),
                        processImageInput(form, 'evolutions_2_source', 'evolutions_2_file', 'evolutions_2_url', form.elements.evolutions_2_current.value)
                    ]);
                    if (!mainUrl) throw new Error("Ana resim boş bırakılamaz.");
                    data.imageUrl = mainUrl;
                    data.evolutions = [];
                    if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                    if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });

                } else if (type === 'fusion') {
                    const [mainUrl, previewUrl] = await Promise.all([
                        processImageInput(form, 'imageUrl_source', 'imageUrl_file', 'imageUrl_url', form.elements.imageUrl_current.value),
                        processImageInput(form, 'previewUrl_source', 'previewUrl_file', 'previewUrl_url', form.elements.previewUrl_current.value)
                    ]);
                    if (!mainUrl) throw new Error("Ana resim boş bırakılamaz.");
                    data.imageUrl = mainUrl;
                    data.previewUrl = previewUrl;
                    data.fusionPartners = [form.elements.fusionPartners_0.value, form.elements.fusionPartners_1.value].filter(Boolean);

                } else if (type === 'easterEgg') {
                    const mainUrl = await processImageInput(form, 'imageUrl_source', 'imageUrl_file', 'imageUrl_url', form.elements.imageUrl_current.value);
                    if (!mainUrl) throw new Error("Ana resim boş bırakılamaz.");
                    data.imageUrl = mainUrl;
                    data.originalCharacterId = form.elements.originalCharacterId.value;
                }
                
                await db.collection(collectionName).doc(id).set(data, { merge: true });
                alert('Kayıt başarıyla güncellendi!');
                await fetchItems();
                closeEditModal();

            } catch (error) {
                alert(`Hata: ${error.message}`);
            } finally {
                saveButton.textContent = 'Güncelle';
                saveButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            Object.assign(dom, {
                appContainer: document.getElementById('app'), addEditFormContainer: document.getElementById('add-edit-form-container'),
                toggleFormBtn: document.getElementById('toggle-form-btn'), toggleFormText: document.getElementById('toggle-form-text'),
                toggleFormIcon: document.getElementById('toggle-form-icon'), addForm: document.getElementById('add-form'),
                adminGrid: document.getElementById('admin-grid'), searchInput: document.getElementById('search-input'),
                noResults: document.getElementById('no-results'), enlargedImageOverlay: document.getElementById('enlarged-image-overlay'),
                enlargedImage: document.getElementById('enlarged-image'), authActionBtn: document.getElementById('auth-action-btn'),
                authActionText: document.getElementById('auth-action-text'), authActionIcon: document.getElementById('auth-action-icon'),
                loginModal: document.getElementById('login-modal'), loginSubmitBtn: document.getElementById('login-submit-btn'),
                adminEmailInput: document.getElementById('admin-email'), adminPasswordInput: document.getElementById('admin-password'),
                loginStatus: document.getElementById('login-status'), 
                characterSelectorModal: document.getElementById('character-selector-modal'), selectorSearchInput: document.getElementById('selector-search-input'),
                selectorGrid: document.getElementById('selector-grid'), viewFilter: document.getElementById('view-filter'), sortBy: document.getElementById('sort-by'),
                reportModal: document.getElementById('report-modal'), reportTitle: document.getElementById('report-title'), reportContent: document.getElementById('report-content'),
                fusionReportBtn: document.getElementById('fusion-report-btn'),
                editModal: document.getElementById('edit-modal'),
                editForm: document.getElementById('edit-form')
            });

            fetchItems();
            
            dom.loginSubmitBtn.addEventListener('click', async () => {
                const email = dom.adminEmailInput.value; const password = dom.adminPasswordInput.value;
                dom.loginStatus.textContent = '';
                try {
                    dom.loginSubmitBtn.disabled = true; dom.loginSubmitBtn.textContent = 'Giriş yapılıyor...';
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) { dom.loginStatus.textContent = `Hata: ${error.code}`;
                } finally { dom.loginSubmitBtn.disabled = false; dom.loginSubmitBtn.textContent = 'Giriş Yap'; }
            });
            
            firebase.auth().onAuthStateChanged(updateAuthUI);
            
            dom.addForm.elements.itemType.addEventListener('change', toggleAddFormFields);
            dom.addForm.addEventListener('submit', handleAddFormSubmit);
            dom.editForm.addEventListener('submit', handleEditFormSubmit);

            dom.addForm.querySelector('#cancel-add-button').addEventListener('click', () => {
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
                resetAddForm();
            });

            dom.searchInput.addEventListener('input', renderAdminPanel);
            dom.viewFilter.addEventListener('change', (e) => { viewState.filter = e.target.value; renderAdminPanel(); });
            dom.sortBy.addEventListener('change', (e) => { viewState.sortBy = e.target.value; renderAdminPanel(); });
            
            dom.toggleFormBtn.addEventListener('click', () => {
                const isHidden = dom.addEditFormContainer.classList.toggle('hidden');
                dom.toggleFormText.textContent = isHidden ? 'Yeni Kayıt' : 'Formu Kapat';
                dom.toggleFormIcon.textContent = isHidden ? 'add' : 'close'; 
                if(isHidden) {
                    resetAddForm();
                } else {
                    toggleAddFormFields();
                    updateUploadServiceVisibility(dom.addForm);
                }
            });

            dom.selectorSearchInput.addEventListener('input', () => renderCharacterSelector(dom.selectorSearchInput.value));
            
            dom.fusionReportBtn.addEventListener('click', () => {
                const reportHtml = generateFusionReport();
                dom.reportTitle.textContent = 'Füzyon Katılım Raporu';
                dom.reportContent.innerHTML = reportHtml;
                openReportModal();
            });

            document.addEventListener('change', (event) => {
                if (event.target.classList.contains('image-source-toggle')) {
                    const form = event.target.closest('form');
                    const container = event.target.closest('.image-input-container, .image-edit-container');
                    const fileWrapper = container.querySelector('.file-input-wrapper');
                    const urlWrapper = container.querySelector('.url-input-wrapper');
                    
                    if (event.target.value === 'url') {
                        if(fileWrapper) fileWrapper.style.display = 'none';
                        if(urlWrapper) urlWrapper.style.display = 'block';
                    } else {
                        if(fileWrapper) fileWrapper.style.display = 'block';
                        if(urlWrapper) urlWrapper.style.display = 'none';
                    }
                    updateUploadServiceVisibility(form);
                }
            });
        });
    </script>
</body>
</html>
